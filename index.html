<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rian Store â€” User Panel</title>
<style>
:root{
  --bg:#f7f8fb;
  --card:#fff;
  --accent:#5c2cf7;
  --muted:#6b7280;
  --danger:#ff4d4f;
  --shadow:0 4px 12px rgba(0,0,0,0.08);
  font-family:Inter,system-ui,sans-serif
}
body{margin:0;background:var(--bg);color:#111827}
.container{max-width:480px;margin:auto;padding:12px}
header{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--card);box-shadow:var(--shadow);border-radius:12px;margin-bottom:12px}
.logo{width:40px;height:40px;background:linear-gradient(135deg,#5c2cf7,#3ddc97);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px}
h1,h2{margin:0;font-size:16px}
p{margin:0;font-size:13px;color:var(--muted)}
.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:var(--shadow)}
input,select{width:100%;padding:12px;margin:6px 0;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;font-size:14px}
button{padding:12px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;width:100%;margin-top:6px}
.btn-primary{background:var(--accent);color:white}
.btn-secondary{background:#eef6ff;color:var(--accent)}
.btn-danger{background:var(--danger);color:white}
.balance{font-weight:700;color:var(--accent);font-size:18px}
.hidden{display:none}
</style>
</head>
<body>

<div class="container" id="login-screen">
  <div class="card">
    <h2>Masuk ke Rian Store</h2>
    <input type="text" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button class="btn-primary" id="login-btn">Masuk</button>
    <p>Belum punya akun?</p>
    <button class="btn-secondary" id="register-btn">Daftar</button>
  </div>
</div>

<div class="container hidden" id="user-panel">
  <header>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="logo">RS</div>
      <div>
        <h1>Rian Store</h1>
        <p id="welcome"></p>
      </div>
    </div>
    <button class="btn-secondary" id="logout-btn">Keluar</button>
  </header>

  <div class="card">
    <h2>Saldo Kamu</h2>
    <p class="balance" id="saldo-display">Rp 0</p>
  </div>

  <div class="card">
    <h2>Beli Produk</h2>
    <select id="product-select"></select>
    <button class="btn-primary" id="buy-btn">Beli Sekarang</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBj1P1BlyVgusvpVJ_5TcJdqnffVm6In6E",
  authDomain: "tokomiken-6fc10.firebaseapp.com",
  projectId: "tokomiken-6fc10",
  storageBucket: "tokomiken-6fc10.appspot.com",
  messagingSenderId: "454827178083",
  appId: "1:454827178083:web:c83c3627d60942d5af2056",
  measurementId: "G-18DVM3HBNY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const ACCOUNTS = 'accounts';
const PRODUCTS = 'products';

const loginScreen = document.getElementById('login-screen');
const userPanel = document.getElementById('user-panel');
const emailInput = document.getElementById('email');
const passInput = document.getElementById('password');
const loginBtn = document.getElementById('login-btn');
const registerBtn = document.getElementById('register-btn');
const logoutBtn = document.getElementById('logout-btn');
const saldoDisplay = document.getElementById('saldo-display');
const productSelect = document.getElementById('product-select');
const welcome = document.getElementById('welcome');

let currentUser = null;
let unsubUser = null;

/* ---- Helper ---- */
function showPanel(show) {
  loginScreen.classList.toggle('hidden', show);
  userPanel.classList.toggle('hidden', !show);
}

/* ---- Register ---- */
registerBtn.onclick = async function() {
  const email = emailInput.value.trim();
  const password = passInput.value.trim();
  if(!email || !password) return alert("Isi email dan password!");
  const name = email.split('@')[0];
  const newUser = {
    email: email,
    password: password,
    name: name,
    wa: "",
    saldo: 0,
  };
  await db.collection(ACCOUNTS).add(newUser);
  alert("Akun berhasil dibuat! Silakan login.");
};

/* ---- Login ---- */
loginBtn.onclick = async function() {
  const email = emailInput.value.trim();
  const password = passInput.value.trim();
  if(!email || !password) return alert("Isi email dan password!");
  
  const q = await db.collection(ACCOUNTS).where("email", "==", email).get();
  if(q.empty) return alert("Akun tidak ditemukan!");
  let user = null;
  q.forEach(d => { if(d.data().password === password) user = {id:d.id, ...d.data()}; });
  if(!user) return alert("Password salah!");

  currentUser = user;
  welcome.innerText = "Halo, " + (user.name || user.email);
  showPanel(true);
  subscribeUser(user.id);
  loadProducts();
};

/* ---- Logout ---- */
logoutBtn.onclick = function() {
  if(unsubUser) unsubUser();
  currentUser = null;
  showPanel(false);
};

/* ---- Realtime user listener ---- */
function subscribeUser(id) {
  if(unsubUser) unsubUser();
  unsubUser = db.collection(ACCOUNTS).doc(id).onSnapshot(doc => {
    const data = doc.data();
    if(data) {
      saldoDisplay.innerText = "Rp " + (data.saldo || 0).toLocaleString();
    }
  });
}

/* ---- Load Produk ---- */
function loadProducts() {
  db.collection(PRODUCTS).onSnapshot(snapshot => {
    productSelect.innerHTML = "";
    snapshot.forEach(doc => {
      const p = doc.data();
      const opt = document.createElement("option");
      opt.value = doc.id;
      opt.textContent = `${p.operator} - ${p.denom} (Rp ${p.price})`;
      productSelect.appendChild(opt);
    });
  });
}

/* ---- Beli Produk ---- */
document.getElementById('buy-btn').onclick = async function() {
  if(!currentUser) return alert("Login dulu!");
  const productId = productSelect.value;
  if(!productId) return alert("Pilih produk!");

  const productDoc = await db.collection(PRODUCTS).doc(productId).get();
  const product = productDoc.data();
  if(!product) return alert("Produk tidak ditemukan!");

  const userRef = db.collection(ACCOUNTS).doc(currentUser.id);
  const userSnap = await userRef.get();
  const userData = userSnap.data();
  if(userData.saldo < product.price) return alert("Saldo tidak cukup!");

  const newSaldo = userData.saldo - product.price;
  await userRef.update({ saldo: newSaldo });
  alert(`Pembelian ${product.operator} - ${product.denom} berhasil!`);
};
</script>
</body>
</html>
